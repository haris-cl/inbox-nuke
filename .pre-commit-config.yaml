# Pre-commit hooks for Inbox Nuke
#
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files
#
# These hooks catch common issues BEFORE code is committed.

repos:
  # ============================================================================
  # General Hooks
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
      - id: end-of-file-fixer
        name: Fix end of files
      - id: check-yaml
        name: Check YAML syntax
      - id: check-json
        name: Check JSON syntax
      - id: check-added-large-files
        name: Check for large files
        args: ['--maxkb=500']
      - id: check-merge-conflict
        name: Check for merge conflicts
      - id: detect-private-key
        name: Detect private keys

  # ============================================================================
  # TODO Scanner - Catches forgotten TODOs
  # ============================================================================
  - repo: local
    hooks:
      - id: check-critical-todos
        name: Check for critical TODOs
        entry: bash -c 'if grep -rn "TODO.*CRITICAL\|FIXME.*CRITICAL\|XXX.*CRITICAL" --include="*.py" --include="*.ts" --include="*.tsx" .; then echo "Critical TODOs found! Fix before committing."; exit 1; fi'
        language: system
        pass_filenames: false
        types: [file]

      - id: count-todos
        name: Count TODOs (info only)
        entry: bash -c 'echo "=== TODO Count ===" && grep -rn "TODO\|FIXME\|XXX" --include="*.py" --include="*.ts" --include="*.tsx" . 2>/dev/null | wc -l | xargs echo "Total TODOs:" || true'
        language: system
        pass_filenames: false
        types: [file]
        verbose: true

  # ============================================================================
  # Python Hooks
  # ============================================================================
  - repo: local
    hooks:
      - id: python-type-check
        name: Python type check (pyright)
        entry: bash -c 'cd backend && if command -v pyright &> /dev/null; then pyright --outputjson 2>/dev/null | python -c "import sys,json; d=json.load(sys.stdin); errors=[i for i in d.get(\"generalDiagnostics\",[]) if i.get(\"severity\")==1]; print(f\"Found {len(errors)} type errors\") if errors else print(\"No type errors\"); sys.exit(1 if errors else 0)"; else echo "pyright not installed, skipping"; fi'
        language: system
        pass_filenames: false
        types: [python]

      - id: check-async-await
        name: Check for missing await on coroutines
        entry: bash -c 'if grep -rn "\.list_messages(\|\.get_message(\|\.get_thread_info(" --include="*.py" backend/ | grep -v "await" | grep -v "async def" | grep -v "#"; then echo "Possible missing await detected!"; exit 1; fi; exit 0'
        language: system
        pass_filenames: false
        types: [python]

  # ============================================================================
  # Frontend Hooks
  # ============================================================================
  - repo: local
    hooks:
      - id: typescript-compile-check
        name: TypeScript compile check
        entry: bash -c 'cd frontend && npm run build 2>&1 | head -20 || true'
        language: system
        pass_filenames: false
        types: [typescript, tsx]

  # ============================================================================
  # API Contract Hooks
  # ============================================================================
  - repo: local
    hooks:
      - id: check-api-types-sync
        name: Check if API types need regeneration
        entry: bash -c 'if [ -f frontend/lib/api-types.ts ]; then echo "Run python scripts/generate-types.py if you changed backend schemas"; fi'
        language: system
        pass_filenames: false
        verbose: true
